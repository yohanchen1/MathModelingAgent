# 数学建模代理 (MathModelingAgent) - v3.0

---

## 摘要 (Abstract)

本项目是一个高级AI代理，旨在自动化解决复杂的、多步骤的数学建模问题。它借鉴了`IMO25`等前沿研究项目通过“分解”和“迭代”解决复杂推理任务的核心思想，并将其应用于数学建模领域。代理能够智能地将一个复杂的问题文档（如PDF）分解为多个独立的子问题，然后对每个子问题启动一个**带明确接受/拒绝标准的、多轮的“建模-分析-修正”循环**，从而逐步求精，生成高质量的、包含完整代码和分析的解决方案。

其核心能力在于：
1.  **智能问题分解**: 自动从问题文档中提取独立的子问题。
2.  **顺序求解**: 逐一解决每个子问题，并将前一个问题的解作为后续问题的上下文。
3.  **鲁棒的迭代式自我修正**: 对每个子问题的解进行多轮“生成-验证-修正”循环，直到满足严格的“接受”或“拒绝”标准，显著提升了方案的深度和可靠性。
4.  **结构化输出**: 为每个子问题的解决过程生成独立的、详细的运行日志、思考过程日志和可视化图表。

这不仅是一个解题工具，更是一次关于“如何让AI进行深度、结构化、多步骤、可自我修正的推理”的成功探索。

## 核心方法论 (Core Methodology)

该框架的核心是一个三阶段的自动化流程，其关键在于第三阶段的智能循环控制：

1.  **问题提取 (Problem Extraction)**:
    *   代理首先读取用户提供的问题目录中的PDF文件。
    *   通过一次LLM调用，它会智能地识别并提取出PDF中所有独立的、编号的子问题。

2.  **顺序求解 (Sequential Solving)**:
    *   代理将提取出的子问题列表作为任务队列，并按顺序逐一解决。

3.  **带控制流的迭代修正循环 (Iterative Refinement Loop with Control Flow)**:
    *   对于**每一个**子问题，代理都会启动一个`while`循环，而非固定的两轮修正。这个循环由明确的“接受”和“拒绝”标准控制：
        *   **建模 (Modeling/Correction)**: “建模者”角色根据当前子问题和已有上下文（包括之前问题的解和上一轮的“bug报告”），生成新一版解决方案。
        *   **分析 (Analysis)**: “分析者”角色对新方案进行严格的批判性审查，并给出一个格式化的最终结论：`FINAL VERDICT: [verdict]`，其中 `verdict` 分为 `Excellent`（无任何问题）或其他（有问题）。
        *   **循环控制 (Loop Control)**:
            *   **如果 verdict 为 `Excellent`**: 这是一个“通过”信号。代理会增加“连续通过次数”计数器。为了确保方案的鲁棒性，只有当**连续通过3次**严格审查后，该方案才被最终“接受”，循环终止。
            *   **如果 verdict 不为 `Excellent`**: 这是一个“失败”信号。“连续通过次数”计数器被重置为0。代理将“分析者”的“bug报告”反馈给“建模者”，进入下一轮修正。
            *   **“拒绝”标准**: 为了避免在有根本缺陷的思路上无限循环，整个循环设置了**最大迭代次数（10次）**。如果超过这个次数仍未达到“接受”标准，代理将放弃当前子问题的求解，并报告失败。

这种“先分解、再逐一击破、最后在严格的品控下自我完善”的策略，有效地克服了大型语言模型在处理复杂长程推理任务时的“思考预算”限制，并确保了最终解决方案的质量和可靠性。

## 设计灵感 (Inspiration)

本项目的设计思路，很大程度上受到了近年来AI在形式推理领域探索的启发，特别是借鉴了 [lyang36/IMO25](https://github.com/lyang36/IMO25) 等研究项目在解决复杂数学问题上所采用的多代理“生成-验证”和“迭代循环”的思想。

## 环境配置 (Setup)

1.  **克隆仓库**

2.  **创建Python虚拟环境** (推荐使用Conda)
    ```bash
    conda create --name math_modeling python=3.9 -y
    conda activate math_modeling
    ```

3.  **安装依赖项**
    ```bash
    pip install -r requirements.txt
    ```

4.  **配置API密钥**
    为了运行代理，您需要一个有效的Gemini API密钥。请在项目的根目录下创建一个名为 `.env` 的文件，并按以下格式填入您的密钥：
    ```
    GEMINI_API_KEY="在这里填入您的API密钥"
    ```
    `agent.py` 脚本会自动从此文件中加载密钥。您也可以选择性地在 `.env` 文件中覆盖 `MODEL_NAME` 和 `BASE_URL`。

## 使用指南 (Usage)

通过命令行执行代理，并使用 `--dir` 参数提供包含问题文件（PDF和相关附件）的目录路径。

```bash
# 在 MathModelingAgent 项目根目录下运行
python code/agent.py --dir problems/cumcm2023
```

- 一个完整的示例问题位于 `problems/cumcm2023` 目录中。
- 代理将自动识别PDF文件和附件。

## 输出结构 (Output Structure)

所有生成的思考过程和结果都保存在 `run_logs` 文件夹中，结构如下：

```
MathModelingAgent/
└── run_logs/
    ├── plots/                     # 存放所有由代码生成的图表 (.png)
    |   ├── plot_problem_1_...
    |   └── ...
    ├── run_log_problem_1.txt      # 问题一的完整解决过程日志
    ├── run_log_problem_2.txt      # 问题二的完整解决过程日志
    ├── ...
    ├── thinking_log_extraction.txt # 提取问题的思考过程
    ├── thinking_log_problem_1_modeler_1.txt # 问题一，第1轮，建模者思考过程
    ├── thinking_log_problem_1_analyzer_1.txt# 问题一，第1轮，分析者思考过程
    ├── thinking_log_problem_1_modeler_2.txt # 问题一，第2轮，建模者思考过程
    └── ... (以此类推，直到满足停止条件)
```

## 未来工作 (Future Work)

- **增强代码执行与调试**: 集成一个代码执行环境（沙箱），让代理不仅能生成代码，还能安全地运行代码、读取输出、并根据运行时错误进行自主调试。
- **引入人类反馈回路 (Human-in-the-loop)**: 在“分析者”生成“bug报告”后，允许人类专家介入审查，剔除其中错误的或不重要的批评，将更高质量的反馈传递给“建模者”，从而极大提高修正效率。
- **动态调整建模策略**: 如果一个建模思路在多次迭代后被“拒绝”，代理可以尝试回溯，并向“建模者”发出指令，要求其从一个全新的角度或使用一种完全不同的模型来重新解决问题。

---

我们欢迎任何形式的交流与贡献，共同探索AI在科学计算领域的未来。